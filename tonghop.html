<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Form ƒêƒÉng k√Ω Gi·∫£i ch·∫°y + Google Sheets</title>
<style>
/* (gi·ªØ nguy√™n style c·ªßa b·∫°n) */
body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;padding:20px}
.container{max-width:820px;margin:20px auto;background:#fff;padding:22px;border-radius:10px;box-shadow:0 6px 24px rgba(20,20,20,0.08)}
h1{color:#2d014d;text-align:center}
.stepper{display:flex;gap:12px;justify-content:center;margin:18px 0}
.dot{width:36px;height:36px;border-radius:50%;background:#ddd;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold}
.dot.active{background:#5a2ca0}
form{margin-top:10px}
.row{display:flex;gap:12px}
.col{flex:1}
label{display:block;font-weight:600;margin:10px 0 6px}
input[type="text"],input[type="email"],input[type="tel"],input[type="date"],input[type="number"],select,textarea{
  width:100%;padding:10px;border:1px solid #cfcfcf;border-radius:6px;font-size:14px;
}
textarea{min-height:80px;resize:vertical}
.actions{display:flex;gap:12px;justify-content:space-between;margin-top:18px}
button{background:#5a2ca0;color:#fff;padding:12px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
button.secondary{background:#fff;color:#5a2ca0;border:2px solid #5a2ca0}
.msg{margin-top:12px;font-weight:600}
.error{color:#c62828}
.success{color:#2e7d32}
.summary{background:#f9f9fb;padding:12px;border-radius:8px;margin-top:12px;border:1px solid #eee}
@media(max-width:720px){ .row{flex-direction:column} }
</style>
</head>
<body>
<div class="container">
  <h1>ƒêƒÉng k√Ω Gi·∫£i ch·∫°y</h1>

  <div class="stepper">
    <div id="dot1" class="dot active">1</div>
    <div id="dot2" class="dot">2</div>
    <div id="dot3" class="dot">3</div>
    <div id="dot4" class="dot">4</div>
  </div>

  <form id="multiForm" onsubmit="return false;">
    <!-- STEP 1 -->
    <div id="step1">
      <h3>B∆∞·ªõc 1 ‚Äî Th√¥ng tin c√° nh√¢n & y t·∫ø</h3>
      <label>H·ªç v√† t√™n *</label>
      <input type="text" id="fullname" placeholder="Nguy·ªÖn VƒÉn A">

      <div class="row">
        <div class="col">
          <label>Ng√†y sinh *</label>
          <input type="date" id="dob">
        </div>
        <div class="col">
          <label>Gi·ªõi t√≠nh *</label>
          <select id="gender">
            <option value="">-- Ch·ªçn --</option>
            <option>Nam</option>
            <option>N·ªØ</option>
            <option>Kh√°c</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Qu·ªëc t·ªãch *</label>
          <select id="nationality">
            <option value="">-- Ch·ªçn qu·ªëc t·ªãch --</option>
            <option value="Vi·ªát Nam">Vi·ªát Nam</option>
            <option value="M·ªπ">M·ªπ</option>
            <option value="Anh">Anh</option>
            <option value="Ph√°p">Ph√°p</option>
            <option value="Nh·∫≠t B·∫£n">Nh·∫≠t B·∫£n</option>
            <option value="H√†n Qu·ªëc">H√†n Qu·ªëc</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
        </div>

        <div class="col">
          <label>T·ªânh / Th√†nh ph·ªë *</label>
          <select id="city">
            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
            <option value="H√† N·ªôi">H√† N·ªôi</option>
            <option value="H·ªì Ch√≠ Minh">H·ªì Ch√≠ Minh</option>
            <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
            <option value="Th·ª´a Thi√™n Hu·∫ø">Th·ª´a Thi√™n Hu·∫ø</option>
            <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
            <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
            <option value="Qu·∫£ng Ninh">Qu·∫£ng Ninh</option>
            <option value="Kh√°c">Kh√°c</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Tu·ªïi</label>
          <input type="number" id="age" min="0" placeholder="25">
        </div>
        <div class="col">
          <label>Nh√≥m m√°u</label>
          <select id="blood">
            <option value="">-- Ch·ªçn --</option>
            <option>A</option><option>B</option><option>AB</option><option>O</option>
          </select>
        </div>
      </div>

      <label>Ng∆∞·ªùi b·∫£o h·ªô (n·∫øu c√≥)</label>
      <input type="text" id="guardian" placeholder="H·ªç t√™n ng∆∞·ªùi b·∫£o h·ªô">

      <div class="actions">
        <div></div>
        <button type="button" id="toStep2">Ti·∫øp t·ª•c ‚Üí</button>
      </div>
      <div id="msg1" class="msg error" style="display:none"></div>
    </div>

    <!-- STEP 2 -->
    <div id="step2" style="display:none">
      <h3>B∆∞·ªõc 2 ‚Äî Th√¥ng tin ƒëƒÉng k√Ω</h3>
      <label>H·ªç v√† t√™n (d√πng cho ƒëƒÉng k√Ω) *</label>
      <input type="text" id="reg_name" placeholder="Nguy·ªÖn VƒÉn A">
      <label>Email *</label>
      <input type="email" id="reg_email" placeholder="email@example.com">
      <label>S·ªë ƒëi·ªán tho·∫°i *</label>
      <input type="tel" id="reg_phone" placeholder="09xxxxxxxx">

      <div class="actions">
        <button type="button" class="secondary" id="backTo1">‚Üê Quay l·∫°i</button>
        <button type="button" id="toStep3">Ti·∫øp t·ª•c ‚Üí</button>
      </div>
      <div id="msg2" class="msg error" style="display:none"></div>
    </div>

    <!-- STEP 3 -->
    <div id="step3" style="display:none">
      <h3>B∆∞·ªõc 3 ‚Äî Thanh to√°n</h3>
      <div class="summary">
        <p><b>S·∫£n ph·∫©m:</b> G√≥i tham gia 10KM - REGULAR</p>
        <p><b>Gi√°:</b> ‚Ç´880,000</p>
      </div>
      <label>Ph∆∞∆°ng th·ª©c thanh to√°n *</label>
      <select id="payment_method">
        <option value="">-- Ch·ªçn --</option>
        <option>Visa / MasterCard</option>
        <option>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
        <option>Momo</option>
        <option>ZaloPay</option>
      </select>
      <label>Th√¥ng tin th·∫ª/t√†i kho·∫£n (n·∫øu c√≥)</label>
      <input type="text" id="card_info" placeholder="S·ªë th·∫ª ho·∫∑c TK (n·∫øu c·∫ßn)">
      <label>M√£ voucher (n·∫øu c√≥)</label>
      <input type="text" id="voucher" placeholder="GIAM10">

      <div class="actions">
        <button type="button" class="secondary" id="backTo2">‚Üê Quay l·∫°i</button>
        <button type="button" id="submitBtn">ƒê·∫∑t h√†ng</button>
      </div>
      <div id="msg3" class="msg error" style="display:none"></div>
    </div>

    <!-- STEP 4 -->
    <div id="step4" style="display:none">
      <h3>üéâ Thanh to√°n th√†nh c√¥ng</h3>
      <div class="summary">
        <p><b>M√£ ƒë∆°n h√†ng:</b> <span id="orderId"></span></p>
        <p><b>Email:</b> <span id="confirmEmail"></span></p>
        <p><b>S·ªë ƒëi·ªán tho·∫°i:</b> <span id="confirmPhone"></span></p>
        <p><b>S·∫£n ph·∫©m:</b> G√≥i tham gia 10KM - REGULAR</p>
        <p><b>Gi√°:</b> ‚Ç´880,000</p>
        <p><b>Tr·∫°ng th√°i:</b> <span id="orderStatus" style="color:green">ƒê√£ thanh to√°n</span></p>
      </div>
      <div style="margin-top:20px; text-align:center">
        <button id="downloadBtn">‚¨áÔ∏è T·∫£i v√©</button>
      </div>
    </div>
  </form>
</div>

<script>
/* ==== Thay b·∫±ng link Web App ƒë√£ deploy c·ªßa b·∫°n ==== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbz3PRp9i2UZUbgtScfrPO0rv3fWqABDH3iWQAKlqCVMALver2n3-afFOS4AUvW0b3go/exec";

/* Buttons */
const toStep2 = document.getElementById('toStep2');
const toStep3 = document.getElementById('toStep3');
const backTo1 = document.getElementById('backTo1');
const backTo2 = document.getElementById('backTo2');
const submitBtn = document.getElementById('submitBtn');

function showStep(n){
  document.getElementById('step1').style.display = (n===1?'block':'none');
  document.getElementById('step2').style.display = (n===2?'block':'none');
  document.getElementById('step3').style.display = (n===3?'block':'none');
  document.getElementById('step4').style.display = (n===4?'block':'none');
  document.getElementById('dot1').classList.toggle('active', n===1);
  document.getElementById('dot2').classList.toggle('active', n===2);
  document.getElementById('dot3').classList.toggle('active', n===3);
  document.getElementById('dot4').classList.toggle('active', n===4);
}

/* b∆∞·ªõc 1 -> 2 */
toStep2.addEventListener('click', ()=>{
  const fullname = document.getElementById('fullname').value.trim();
  const dob = document.getElementById('dob').value;
  const gender = document.getElementById('gender').value;
  const msg1 = document.getElementById('msg1');
  msg1.style.display = 'none';
  if(!fullname || !dob || !gender){
    msg1.textContent = "Vui l√≤ng nh·∫≠p H·ªç t√™n, Ng√†y sinh v√† Gi·ªõi t√≠nh.";
    msg1.style.display = 'block';
    return;
  }
  showStep(2);
});
backTo1.addEventListener('click', ()=> showStep(1));

/* b∆∞·ªõc 2 -> 3 */
toStep3.addEventListener('click', ()=>{
  const name = document.getElementById('reg_name').value.trim();
  const email = document.getElementById('reg_email').value.trim();
  const phone = document.getElementById('reg_phone').value.trim();
  const msg2 = document.getElementById('msg2');
  msg2.style.display = 'none';
  if(!name || !email || !phone){
    msg2.textContent = "Vui l√≤ng nh·∫≠p H·ªç t√™n (ƒëƒÉng k√Ω), Email v√† S·ªë ƒëi·ªán tho·∫°i.";
    msg2.style.display = 'block';
    return;
  }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
    msg2.textContent = "Email kh√¥ng h·ª£p l·ªá.";
    msg2.style.display = 'block';
    return;
  }
  if(!/^[0-9\+\-\s]{7,15}$/.test(phone)){
    msg2.textContent = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá.";
    msg2.style.display = 'block';
    return;
  }
  showStep(3);
});
backTo2.addEventListener('click', ()=> showStep(2));

/* submit -> g·ª≠i l√™n GAS */
submitBtn.addEventListener('click', async ()=> {
  const payment = document.getElementById('payment_method').value;
  const card = document.getElementById('card_info').value.trim();
  const voucher = document.getElementById('voucher').value.trim();
  const msg3 = document.getElementById('msg3');
  msg3.style.display = 'none';

  if(!payment){
    msg3.textContent = "Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.";
    msg3.style.display = 'block';
    return;
  }

  const payload = {
    fullname: document.getElementById('fullname').value.trim(),
    dob: document.getElementById('dob').value,
    gender: document.getElementById('gender').value,
    nationality: document.getElementById('nationality').value,
    city: document.getElementById('city').value,
    age: document.getElementById('age').value,
    blood: document.getElementById('blood').value,
    guardian: document.getElementById('guardian').value.trim(),
    reg_name: document.getElementById('reg_name').value.trim(),
    reg_email: document.getElementById('reg_email').value.trim(),
    reg_phone: document.getElementById('reg_phone').value.trim(),
    payment_method: payment,
    card_info: card,
    voucher: voucher,
    status: "ƒê√£ thanh to√°n"   // ‚úÖ th√™m tr·∫°ng th√°i
  };

  // disable n√∫t ƒë·ªÉ tr√°nh g·ª≠i nhi·ªÅu l·∫ßn
  submitBtn.disabled = true;
  submitBtn.style.opacity = 0.6;

  try {
    console.log("G·ª≠i payload t·ªõi GAS:", payload);

    const res = await fetch(GAS_URL, {
      method: 'POST',
      mode: 'cors',
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    console.log("HTTP status:", res.status, "response text:", text);

    let data;
    try {
      data = JSON.parse(text);
    } catch(e){
      throw new Error("Server tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON: " + text);
    }

    if(res.ok && data.status === 'success'){
      const orderId = "EE" + Math.random().toString(36).substr(2,5).toUpperCase();
      document.getElementById('orderId').textContent = orderId;
      document.getElementById('confirmEmail').textContent = payload.reg_email;
      document.getElementById('confirmPhone').textContent = payload.reg_phone;
      document.getElementById('orderStatus').textContent = payload.status;
      showStep(4);
    } else {
      throw new Error("Server tr·∫£ v·ªÅ l·ªói: " + (data.message || JSON.stringify(data)));
    }
  } catch(err){
    console.error("L·ªói g·ª≠i t·ªõi GAS:", err);
    msg3.textContent = "L·ªói m·∫°ng ho·∫∑c CORS: " + err.message;
    msg3.style.display = 'block';
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
  }
});

/* T·∫£i v√© (file TXT ƒë∆°n gi·∫£n) */
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const content = `
V√© tham gia gi·∫£i ch·∫°y Hu·∫ø Heritage Trail
----------------------------
M√£ ƒë∆°n: ${document.getElementById('orderId').textContent}
Email: ${document.getElementById('confirmEmail').textContent}
SƒêT: ${document.getElementById('confirmPhone').textContent}
S·∫£n ph·∫©m: 10KM - REGULAR
Gi√°: ‚Ç´880,000
Tr·∫°ng th√°i: ${document.getElementById('orderStatus').textContent}
  `;
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ve_tham_gia.txt";
  link.click();
});

showStep(1);
</script>
</body>
</html>
