<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ƒêƒÉng k√Ω Hu·∫ø Heritage Trail 2025</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6fa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 750px;
      margin: auto;
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
    }
    h2 {
      color: #333;
      text-align: center;
      margin-bottom: 15px;
    }
    .step { display: none; }
    .step.active { display: block; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .btn {
      background: #7b2ff7;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 8px;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn:hover { opacity: 0.9; }
    .btn.back { background: #aaa; }
    .btn.home { background: #27ae60; }
    .error { color: red; font-size: 14px; margin-top: 4px; }

    /* V√© ƒëi·ªán t·ª≠ */
    .ticket {
      width: 360px;
      margin: auto;
      background: #fff;
      padding: 20px;
      text-align: center;
      line-height: 1.6;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      transform: scale(0.95);
      transform-origin: top center;
    }
    .ticket img.banner {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .ticket h3 { margin: 6px 0; color: #7b2ff7; }
    .ticket .highlight { color: #f39c12; font-weight: bold; }
    .ticket p { margin: 4px 0; font-size: 14px; }
    #qrcode { display: flex; justify-content: center; margin-top: 10px; }
    .footer { margin-top: 10px; font-size: 12px; color: #555; }
    .payment-qr {
      width: 180px;
      height: 180px;
      border: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: auto;
    }
  </style>
</head>
<body>
<div class="container">
  <form id="regForm" onsubmit="return false">

    <!-- B∆∞·ªõc 1 -->
    <div id="step1" class="step active">
      <h2>üé´ Ch·ªçn lo·∫°i v√©</h2>
      <div class="form-group">
        <label>Lo·∫°i v√©</label>
        <select id="ticket">
          <option value="5km - 200000">5KM - 200,000ƒë</option>
          <option value="10km - 300000">10KM - 300,000ƒë</option>
          <option value="21km - 500000">21KM - 500,000ƒë</option>
        </select>
      </div>
      <button type="button" class="btn" onclick="nextStep(2)">Ti·∫øp t·ª•c</button>
    </div>

    <!-- B∆∞·ªõc 2 -->
    <div id="step2" class="step">
      <h2>üë§ Th√¥ng tin c√° nh√¢n</h2>
      <div class="form-group"><label>H·ªç v√† t√™n</label><input type="text" id="fullname"></div>
      <div class="form-group"><label>Gi·ªõi t√≠nh</label>
        <select id="gender">
          <option>Nam</option><option>N·ªØ</option><option>Kh√°c</option>
        </select>
      </div>
      <div class="form-group"><label>Email</label><input type="email" id="email"></div>
      <div class="form-group"><label>S·ªë ƒëi·ªán tho·∫°i</label><input type="text" id="phone"></div>
      <div class="form-group"><label>ƒêi·ªán tho·∫°i kh·∫©n c·∫•p</label><input type="text" id="emergencyPhone"></div>

      <div class="form-group">
        <label>Qu·ªëc gia</label>
        <select id="country">
          <option>Vi·ªát Nam</option>
          <option>Th√°i Lan</option>
          <option>Singapore</option>
          <option>Malaysia</option>
          <option>Nh·∫≠t B·∫£n</option>
          <option>H√†n Qu·ªëc</option>
        </select>
      </div>

      <div class="form-group">
        <label>Qu·ªëc t·ªãch</label>
        <select id="nationality">
          <option>Vi·ªát Nam</option>
          <option>Th√°i Lan</option>
          <option>Singapore</option>
          <option>Malaysia</option>
          <option>Nh·∫≠t B·∫£n</option>
          <option>H√†n Qu·ªëc</option>
        </select>
      </div>

      <div class="form-group">
        <label>T·ªânh/Th√†nh ph·ªë</label>
        <select id="city">
          <option>H√† N·ªôi</option>
          <option>Hu·∫ø</option>
          <option>ƒê√† N·∫µng</option>
          <option>TP. H·ªì Ch√≠ Minh</option>
          <option>H·∫£i Ph√≤ng</option>
          <option>C·∫ßn Th∆°</option>
        </select>
      </div>

      <div class="form-group">
        <label><input type="checkbox" id="ageConfirm"> T√¥i x√°c nh·∫≠n ƒë√£ ƒë·ªß 18 tu·ªïi.</label>
        <div id="ageError" class="error" style="display:none;">‚ö†Ô∏è B·∫°n ph·∫£i x√°c nh·∫≠n ƒë√£ ƒë·ªß 18 tu·ªïi!</div>
      </div>
      <button type="button" class="btn back" onclick="nextStep(1)">Quay l·∫°i</button>
      <button type="button" class="btn" onclick="validateAgeAndContinue()">Ti·∫øp t·ª•c</button>
    </div>

    <!-- B∆∞·ªõc 3 -->
    <div id="step3" class="step">
      <h2>üíâ Th√¥ng tin y t·∫ø</h2>
      <div class="form-group">
        <label>Nh√≥m m√°u</label>
        <select id="bloodType">
          <option>A</option><option>B</option><option>AB</option><option>O</option>
        </select>
      </div>
      <div class="form-group"><label>B·ªánh l√Ω (n·∫øu c√≥)</label><input type="text" id="disease"></div>
      <div class="form-group"><label>D·ªã ·ª©ng (n·∫øu c√≥)</label><input type="text" id="allergy"></div>
      <div class="form-group"><label>Thu·ªëc ƒëang s·ª≠ d·ª•ng</label><input type="text" id="medicine"></div>
      <button type="button" class="btn back" onclick="nextStep(2)">Quay l·∫°i</button>
      <button type="button" class="btn" onclick="nextStep(4);updatePaymentQR();">Ti·∫øp t·ª•c</button>
    </div>

    <!-- B∆∞·ªõc 4 -->
    <div id="step4" class="step">
      <h2>üí∞ Thanh to√°n</h2>
      <div class="form-group">
        <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
        <select id="paymentMethod">
          <option value="Banking">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
          <option value="Momo">Momo</option>
        </select>
      </div>
      <div id="paymentArea">
        <div class="payment-qr" id="paymentQR">[QR hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
      </div>
      <button type="button" class="btn back" onclick="nextStep(3)">Quay l·∫°i</button>
      <button type="button" class="btn" onclick="confirmPayment()">X√°c nh·∫≠n thanh to√°n</button>
    </div>

    <!-- B∆∞·ªõc 5 -->
    <div id="step5" class="step">
      <h2>üéü V√© ƒëi·ªán t·ª≠ c·ªßa b·∫°n</h2>
      <div class="ticket" id="ticketCard">
        <img src="hinhanh/hinhbaner.jpg" class="banner">
        <p><b>Ng√†y t·ªï ch·ª©c:</b> 02/11/2025</p>
        <p><b>ƒê·ªãa ƒëi·ªÉm:</b> Ngh√™nh L∆∞∆°ng ƒê√¨nh, Hu·∫ø</p>
        <h3 class="highlight">TH·∫∫ NH·∫¨N RACEKIT - 01/11/2025</h3>
        <h3>Hu·∫ø Heritage Trail 2025</h3>
        <p><b>V·∫≠n ƒë·ªông vi√™n:</b> <span id="pv_fullname"></span></p>
        <p><b>Email:</b> <span id="pv_email"></span></p>
        <p><b>Lo·∫°i v√©:</b> <span id="pv_ticket"></span></p>
        <p><b>Gi√°:</b> <span id="pv_price"></span></p>
        <p><b>M√£ v√©:</b> <span id="pv_order"></span></p>
        <div id="qrcode"></div>
        <div class="footer">HU·∫æ HERITAGE TRAIL 2025</div>
      </div>
      <br>
      <button type="button" class="btn home" onclick="resetForm()">üè† Trang ch·ªß</button>
      <button type="button" class="btn" onclick="sendTicketToEmail()">üìß G·ª≠i v√© qua Email</button>
      <button type="button" class="btn" onclick="downloadTicketPDF()">üíæ T·∫£i v√© PDF</button>
    </div>
  </form>
</div>

<!-- JS th∆∞ vi·ªán -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxeFibkXXo8J2gWWptZ17luN5in9JdgSpCX3L6r2ry9OsPwdvg8idwUca4x7o3BLj-Rcg/exec";

function nextStep(s) {
  document.querySelectorAll(".step").forEach(el => el.classList.remove("active"));
  document.getElementById("step" + s).classList.add("active");
}

function validateAgeAndContinue() {
  const name = fullname.value.trim(), mail = email.value.trim();
  if (!name || !mail) { alert("‚ö†Ô∏è Nh·∫≠p h·ªç t√™n v√† email!"); return; }
  if (!ageConfirm.checked) { ageError.style.display = "block"; return; }
  ageError.style.display = "none";
  nextStep(3);
}

function updatePaymentQR() {
  const method = paymentMethod.value;
  const qr = document.getElementById("paymentQR");
  const price = ticket.value.split("-")[1].trim().replace("ƒë", "");
  qr.innerHTML = method === "Banking"
    ? `<img src="https://img.vietqr.io/image/MB-0336446817-compact.png?amount=${price}&addInfo=HHT2025" style="width:180px;">`
    : `<img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" style="width:180px;"><p>Qu√©t m√£ Momo ƒë·ªÉ thanh to√°n ${price}ƒë</p>`;
}

function confirmPayment() {
  generateTicket();
  const data = new URLSearchParams();
  data.append("fullname", fullname.value);
  data.append("email", email.value);
  data.append("phone", phone.value);
  data.append("country", country.value);
  data.append("nationality", nationality.value);
  data.append("city", city.value);
  data.append("bloodType", bloodType.value);
  data.append("disease", disease.value);
  data.append("allergy", allergy.value);
  data.append("medicine", medicine.value);
  data.append("ticket", ticket.value.split("-")[0].trim());
  data.append("price", ticket.value.split("-")[1].trim());
  data.append("orderId", pv_order.innerText);
  data.append("paymentMethod", paymentMethod.value);
  data.append("time", new Date().toLocaleString("vi-VN"));
  fetch(GAS_URL, { method: "POST", body: data })
    .then(r => r.text())
    .then(t => console.log("‚úÖ ƒê√£ g·ª≠i l√™n Google Sheets:", t))
    .catch(e => console.error("‚ùå L·ªói g·ª≠i:", e));
}

function generateTicket() {
  const [type, price] = ticket.value.split("-");
  const orderId = "HHT2025" + Math.floor(Math.random() * 9000 + 1000);
  pv_fullname.innerText = fullname.value;
  pv_email.innerText = email.value;
  pv_ticket.innerText = type.trim();
  pv_price.innerText = price.trim() + "ƒë";
  pv_order.innerText = orderId;
  qrcode.innerHTML = "";
  new QRCode(qrcode, { text: orderId, width: 150, height: 150 });
  nextStep(5);
}

async function sendTicketToEmail() {
  const emailVal = email.value.trim();
  if (!emailVal) return alert("‚ö†Ô∏è Nh·∫≠p email tr∆∞·ªõc!");
  const pdfBase64 = await generatePDFBase64();
  const params = new URLSearchParams();
  params.append("action", "saveAndMail");
  params.append("email", emailVal);
  params.append("fileName", "Ve_HHT2025.pdf");
  params.append("pdfBase64", pdfBase64);
  fetch(GAS_URL, { method: "POST", body: params })
    .then(() => alert("‚úÖ V√© ƒë√£ g·ª≠i t·ªõi: " + emailVal))
    .catch(() => alert("‚ùå G·ª≠i email l·ªói!"));
}

function downloadTicketPDF() {
  const { jsPDF } = window.jspdf;
  html2canvas(ticketCard, { scale: 2 }).then(canvas => {
    const img = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "pt", "a4");
    const w = pdf.internal.pageSize.getWidth();
    const iw = w * 0.6;
    const ih = canvas.height * iw / canvas.width;
    const x = (w - iw) / 2, y = 100;
    pdf.addImage(img, "PNG", x, y, iw, ih);
    pdf.save("Ve_HueHeritageTrail.pdf");
  });
}

function generatePDFBase64() {
  return new Promise(resolve => {
    const { jsPDF } = window.jspdf;
    html2canvas(ticketCard, { scale: 2 }).then(canvas => {
      const pdf = new jsPDF("p", "pt", "a4");
      const img = canvas.toDataURL("image/png");
      const w = pdf.internal.pageSize.getWidth();
      const iw = w * 0.6;
      const ih = canvas.height * iw / canvas.width;
      const x = (w - iw) / 2, y = 100;
      pdf.addImage(img, "PNG", x, y, iw, ih);
      const base64 = btoa(
        new Uint8Array(pdf.output("arraybuffer")).reduce((d, b) => d + String.fromCharCode(b), "")
      );
      resolve(base64);
    });
  });
}

function resetForm() {
  regForm.reset();
  nextStep(1);
}
</script>
</body>
</html>
